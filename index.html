<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>生日快樂❤!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <!-- Snake Game Overlay -->
    <div id="snake-game-overlay" style="position:fixed;z-index:999;width:100vw;height:100dvh;top:0;left:0;background:#ad5072;display:flex;align-items:center;justify-content:center;flex-direction:column;transition:opacity 0.8s cubic-bezier(.4,0,.2,1);opacity:1;">
      <canvas id="snake-canvas" style="background:#ad5072;box-shadow:0 0 30px #ad5072;width:90vw;max-width:480px;height:90vw;max-height:480px;touch-action:none;"></canvas>
      <div id="snake-controls" style="margin-top:18px;display:flex;flex-direction:column;align-items:center;">
        <button id="snake-start-btn" style="margin-bottom:12px;padding:12px 32px;font-size:1.3em;border-radius:8px;border:none;background:#fff;color:#ad5072;box-shadow:0 2px 8px #888;cursor:pointer;">Start</button>
        <div id="snake-virtual-keys" style="display:none;flex-direction:column;align-items:center;gap:4px;">
          <div>
            <button class="vk" data-dir="up" style="width:48px;height:48px;font-size:2em;border-radius:8px;border:none;background:#fff;color:#ad5072;margin:2px;">↑</button>
          </div>
          <div>
            <button class="vk" data-dir="left" style="width:48px;height:48px;font-size:2em;border-radius:8px;border:none;background:#fff;color:#ad5072;margin:2px;">←</button>
            <button class="vk" data-dir="down" style="width:48px;height:48px;font-size:2em;border-radius:8px;border:none;background:#fff;color:#ad5072;margin:2px;">↓</button>
            <button class="vk" data-dir="right" style="width:48px;height:48px;font-size:2em;border-radius:8px;border:none;background:#fff;color:#ad5072;margin:2px;">→</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Avatar -->
    <div class="cs" style="display:none;"></div>
    <canvas class="canvas" width="1820" height="905" style="display:none;opacity:0;transition:opacity 1.2s cubic-bezier(.4,0,.2,1);"></canvas>
    <!-- Birthday wishes -->
    <p class="text" style="display:none;">
        <span id="typewriter"></span><br />
        <span class="life-time-label">妳來到這個世界已經</span> <span id="span_dt_dt"></span>
        <br />
        <span id="random-words" style="font-size: 1.2em; color: #ffffdd;"></span>
    </p>
    <script>
    // Simple pixel snake game with start button and border
    (function(){
      const overlay = document.getElementById('snake-game-overlay');
      const canvas = document.getElementById('snake-canvas');
      const ctx = canvas.getContext('2d');
      const startBtn = document.getElementById('snake-start-btn');
      // 動態計算 grid 與 size 以適應手機
      function getCanvasSize() {
        const vw = Math.min(window.innerWidth, window.innerHeight);
        return Math.min(480, Math.floor(vw * 0.9));
      }
      let size = getCanvasSize();
      let grid = Math.floor(size / 20); // 20格
      let count = 0;
      let snake, apple, playing, started;
      function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min)) + min;
      }
      // 產生一個隨機格線座標，確保不會超出邊界
      function getRandomGridPos() {
        // size/grid 可能不是整數，需向下取整
        const cells = Math.floor(size / grid);
        // 保證產生的格線座標在 0 ~ (cells-1)*grid 之間，且不會超出邊界
        return Math.min(getRandomInt(0, cells), cells - 1) * grid;
      }
      function resizeCanvas() {
        size = getCanvasSize();
        grid = Math.floor(size / 20);
        canvas.width = size;
        canvas.height = size;
      }
      function resetGame() {
        resizeCanvas();
        const mid = Math.floor(size/2/grid)*grid;
        snake = {x:mid, y:mid, dx:grid, dy:0, cells:[], maxCells:4};
        apple = {x:getRandomGridPos(), y:getRandomGridPos()};
        playing = false;
        started = false;
        startBtn.style.display = '';
        ctx.fillStyle = '#ad5072';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        drawBorder();
        ctx.fillStyle = '#fff';
        ctx.font = 'bold ' + Math.floor(size/12) + 'px monospace';
        ctx.textAlign = 'center';
        ctx.fillText('Snake Game', size/2, size/2-20);
        ctx.font = Math.floor(size/22) + 'px monospace';
        ctx.fillText('Press Start', size/2, size/2+30);
        ctx.font = Math.floor(size/28) + 'px monospace';
        ctx.fillText('Use ↑↓←→ or WASD', size/2, size/2+60);
      }
      window.addEventListener('resize', function(){
        // 若遊戲未開始則重設，若遊戲進行中則不自動 resize 以避免格線錯位
        if (!playing && !started) {
          resetGame();
        }
      });
      function drawBorder() {
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 4;
        ctx.strokeRect(2,2,size-4,size-4);
      }
      document.addEventListener('keydown', function(e) {
        if (!playing) return;
        const key = e.key;
        if ((key === 'ArrowLeft' || key === 'a' || key === 'A') && snake.dx === 0) { snake.dx = -grid; snake.dy = 0; }
        else if ((key === 'ArrowUp' || key === 'w' || key === 'W') && snake.dy === 0) { snake.dy = -grid; snake.dx = 0; }
        else if ((key === 'ArrowRight' || key === 'd' || key === 'D') && snake.dx === 0) { snake.dx = grid; snake.dy = 0; }
        else if ((key === 'ArrowDown' || key === 's' || key === 'S') && snake.dy === 0) { snake.dy = grid; snake.dx = 0; }
      });
      // 虛擬按鍵（手機/平板）
      document.querySelectorAll('.vk').forEach(btn => {
        btn.addEventListener('touchstart', function(e) {
          e.preventDefault();
          if (!playing) return;
          const dir = btn.getAttribute('data-dir');
          if (dir === 'left' && snake.dx === 0) { snake.dx = -grid; snake.dy = 0; }
          else if (dir === 'up' && snake.dy === 0) { snake.dy = -grid; snake.dx = 0; }
          else if (dir === 'right' && snake.dx === 0) { snake.dx = grid; snake.dy = 0; }
          else if (dir === 'down' && snake.dy === 0) { snake.dy = grid; snake.dx = 0; }
        });
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          if (!playing) return;
          const dir = btn.getAttribute('data-dir');
          if (dir === 'left' && snake.dx === 0) { snake.dx = -grid; snake.dy = 0; }
          else if (dir === 'up' && snake.dy === 0) { snake.dy = -grid; snake.dx = 0; }
          else if (dir === 'right' && snake.dx === 0) { snake.dx = grid; snake.dy = 0; }
          else if (dir === 'down' && snake.dy === 0) { snake.dy = grid; snake.dx = 0; }
        });
      });
      startBtn.addEventListener('click', function(){
        if (started) return;
        started = true;
        startBtn.style.display = 'none';
        // 顯示虛擬方向鍵
        document.getElementById('snake-virtual-keys').style.display = 'flex';
        playing = true;
        // 重新依目前畫布大小初始化蛇與蘋果位置
        const mid = Math.floor(size/2/grid)*grid;
        snake = {x:mid, y:mid, dx:grid, dy:0, cells:[], maxCells:4};
        apple = {x:getRandomGridPos(), y:getRandomGridPos()};
      });
      function loop() {
        requestAnimationFrame(loop);
        if (!playing) return;
        if (++count < 20) return; // 控制速度（數字越大越慢）
        count = 0;
        ctx.fillStyle = '#ad5072';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        drawBorder();
        snake.x += snake.dx;
        snake.y += snake.dy;
        // check border (fix: grid對齊，不能用4px，應用0和size-grid)
        if (snake.x < 0 || snake.x >= size || snake.y < 0 || snake.y >= size) { playing = false; showEnd(); return; }
        snake.cells.unshift({x:snake.x, y:snake.y});
        if (snake.cells.length > snake.maxCells) snake.cells.pop();
        ctx.fillStyle = '#ffeb3b';
        // 若食物超出邊界則重新產生
        const cells = Math.floor(size / grid);
        if (
          apple.x < 0 || apple.y < 0 ||
          apple.x > (cells-1)*grid || apple.y > (cells-1)*grid
        ) {
          apple.x = getRandomGridPos();
          apple.y = getRandomGridPos();
        }
        ctx.fillRect(apple.x, apple.y, grid-2, grid-2);
        ctx.fillStyle = '#fff';
        snake.cells.forEach((c, idx) => {
          ctx.fillRect(c.x, c.y, grid-2, grid-2);
        });
        // 檢查吃到蘋果（避免 resize 後格線錯位）
        if (snake.x === apple.x && snake.y === apple.y) {
          snake.maxCells++;
          // 產生新蘋果時確保落在格線上且不超出邊界
          apple.x = getRandomGridPos();
          apple.y = getRandomGridPos();
        }
        // 檢查自咬
        for (let i=1; i<snake.cells.length; i++) {
          if (snake.x === snake.cells[i].x && snake.y === snake.cells[i].y) {
            playing = false; showEnd(); return;
          }
        }
      }
      function showEnd() {
        // 先做淡出動畫
        overlay.style.opacity = 0;
        // 隱藏虛擬方向鍵
        document.getElementById('snake-virtual-keys').style.display = 'none';
        setTimeout(()=>{
          overlay.style.display = 'none';
          document.querySelector('.cs').style.display = '';
          const canvasEl = document.querySelector('.canvas');
          const textEl = document.querySelector('.text');
          canvasEl.style.display = '';
          textEl.style.display = '';
          // 生日動畫淡入
          setTimeout(()=>{
            canvasEl.style.opacity = 1;
          }, 30);
        }, 900);
      }
      resetGame();
      loop();
    })();
    // Typewriter effect
    const message = "寶寶，生日快樂！";
    let typeIdx = 0;
    function typeWriter() {
        if (typeIdx <= message.length) {
            document.getElementById('typewriter').innerText = message.slice(0, typeIdx);
            typeIdx++;
            setTimeout(typeWriter, 120);
        }
    }
    window.addEventListener('DOMContentLoaded', typeWriter);

    // Random sweet words
    const words = [
        "子紜生日快樂w",
        "今天也要開心喔！",
        "我會一直陪著妳。",
        "大好きだよ ❤",
        "有妳真好。",
        "想你了~",
        "你是我最珍貴的寶物。"
    ];
    function showRandomWord() {
        const el = document.getElementById('random-words');
        el.innerText = words[Math.floor(Math.random() * words.length)];
    }
    setInterval(showRandomWord, 4000);
    window.addEventListener('DOMContentLoaded', showRandomWord);
    </script>
    <!-- Birthday counter -->
    <script type="text/javascript" src="time.js"></script>
    <!-- Canvas animation -->
    <script type="text/javascript" src="index.js"></script>
    <script>
    // Dot-matrix message carousel
    window.addEventListener('DOMContentLoaded', function() {
        if (window.S && S.UI && typeof S.UI.simulate === 'function') {
            // Auto line break for Happy Birthday on mobile
            function getMessages() {
                const isMobile = window.innerWidth <= 600;
                return [
                    "喵w",
                    "❤",
                    "LOVE",
                    isMobile ? "生日\n快樂" : "生日快樂",
                    "我愛妳",
                    "大好き"
                ].concat(isMobile ? [] : ["(♡˙︶˙♡)"]);
            }
            let messages = getMessages();
            let idx = 0;
            setInterval(function() {
                // Update messages if screen size changes
                const newMessages = getMessages();
                if (messages[1] !== newMessages[1]) {
                    messages = newMessages;
                }
                S.UI.simulate(`#letter ${messages[idx]}`);
                idx = (idx + 1) % messages.length;
            }, 5000);
        }
    });
    </script>
    <!-- Copyright -->
    <footer class="copyright-footer">
        ©2025 伊藤蒼太 itou Souta
    </footer>
</body>
</html>
